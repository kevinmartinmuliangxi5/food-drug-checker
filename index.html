<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµªæµªå±±å°ç”»å¸ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <style>
        /* --- æ ·å¼é…ç½® (ä¿æŒä¸å˜) --- */
        :root {
            --primary-color: #ff7043;
            --secondary-color: #8d6e63;
            --bg-gradient: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            --card-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --font-main: 'ZCOOL KuaiLe', cursive, sans-serif;
        }

        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-image: var(--bg-gradient); 
            font-family: var(--font-main); 
            user-select: none; -webkit-user-select: none;
        }

        #app { width: 100vw; height: 100vh; position: relative; overflow: hidden; }

        .btn {
            background: linear-gradient(45deg, #ff7043, #ffca28);
            border: none; border-radius: 50px;
            color: white; font-family: var(--font-main);
            font-size: 24px; padding: 12px 30px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(255, 112, 67, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.95); }
        .btn-icon { margin-right: 10px; font-size: 28px; }

        /* æ¬¢è¿é¡µå°é¢ */
        .screen-welcome {
            position: absolute; inset: 0; z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 80px;
            /* ç¡®ä¿ cover.jpg åœ¨æ–‡ä»¶å¤¹é‡Œ */
            background: url('cover.jpg') no-repeat center center;
            background-size: cover;
        }
        .screen-welcome::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.2) 60%, rgba(255,255,255,0.9) 100%);
            pointer-events: none;
        }

        .logo-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            padding: 30px 60px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center; border: 3px solid #fff;
            animation: popIn 0.8s ease-out;
            position: relative; z-index: 10;
        }
        .app-title { font-size: 60px; color: #5d4037; margin: 0; text-shadow: 3px 3px 0 #fff; }
        .app-subtitle { font-size: 28px; color: #795548; margin-top: 5px; margin-bottom: 25px; }

        .screen-map {
            position: absolute; inset: 0; z-index: 90;
            padding: 40px; overflow-y: auto;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 30px;
        }
        .level-card {
            width: 130px; height: 150px;
            background: var(--card-bg); border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: all 0.3s; border: 3px solid transparent;
        }
        .level-card.locked { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
        .level-card.unlocked { border-color: #ffca28; cursor: pointer; background: #fff; transform: translateY(-5px); }
        .level-num { 
            width: 40px; height: 40px; background: #ff7043; color: white; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold; margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(255, 112, 67, 0.3);
        }
        .level-name { font-size: 16px; color: #5d4037; text-align: center; padding: 0 5px;}
        .level-stars { font-size: 12px; margin-top: 5px; color: #ffca28; }

        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .story-book {
            width: 650px; height: 450px; background: #fffbf0;
            border-radius: 20px; border: 8px solid #8d6e63;
            display: flex; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: bookOpen 0.6s ease-out;
            position: relative;
        }
        .story-left {
            width: 40%; background: #ffe0b2; 
            display: flex; justify-content: center; align-items: center; font-size: 80px;
            background-size: cover; background-position: center;
        }
        .story-right {
            width: 60%; padding: 30px; display: flex; flex-direction: column; justify-content: center;
        }
        .story-text { font-size: 22px; line-height: 1.5; color: #5d4037; margin-bottom: 20px; white-space: pre-wrap;}
        
        .screen-game { position: absolute; inset: 0; z-index: 80; background: #fdfbf7; }
        .game-header {
            position: absolute; top: 0; left: 0; right: 0; height: 80px;
            padding: 0 30px; display: flex; justify-content: space-between; align-items: center;
            z-index: 50; pointer-events: none;
        }
        .game-header > * { pointer-events: auto; }
        
        #container { position: absolute; inset: 0; z-index: 10; touch-action: none; }
        
        .guide-layer {
            position: absolute; inset: 0; z-index: 5; 
            display: flex; justify-content: center; align-items: center; pointer-events: none;
        }
        
        .guide-svg { width: 90%; height: 90%; fill: none; stroke: #ccc; stroke-width: 24; stroke-linecap: round; stroke-linejoin: round; }
        
        .guide-image {
            max-width: 80%; max-height: 80%;
            opacity: 0.3; filter: grayscale(100%); border: 2px dashed #ccc;
        }

        .stamp-modal {
            position: absolute; inset: 0; z-index: 300;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.95);
            animation: fadeIn 0.3s;
        }
        .stamp {
            width: 200px; height: 200px; border: 8px solid #d32f2f; border-radius: 50%;
            color: #d32f2f; display: flex; justify-content: center; align-items: center;
            font-size: 40px; font-weight: bold; transform: rotate(-15deg) scale(0);
            animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            background: rgba(211, 47, 47, 0.05); text-transform: uppercase;
        }

        /* æœ—è¯»æŒ‰é’® */
        .speak-btn {
            background: none; border: 2px solid #ff7043; color: #ff7043;
            border-radius: 20px; padding: 5px 15px; cursor: pointer;
            margin-bottom: 10px; align-self: flex-start;
        }

        @keyframes popIn { 0% {transform: scale(0.8); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }
        @keyframes bookOpen { from {transform: perspective(1000px) rotateY(90deg); opacity: 0;} to {transform: perspective(1000px) rotateY(0); opacity: 1;} }
        @keyframes stampIn { to {transform: rotate(-15deg) scale(1);} }

    </style>
</head>
<body>

<div id="app">
    
    <!-- 1. æ¬¢è¿é¡µ -->
    <div v-if="state === 'welcome'" class="screen-welcome">
        <div class="logo-card">
            <h1 class="app-title">æµªæµªå±±å°ç”»å¸ˆ</h1>
            <div class="app-subtitle">å¤å¤©ä¸“å± Â· è¯­éŸ³æ•…äº‹ç‰ˆ</div>
            <button class="btn" @click="enterMap">
                <span class="btn-icon">ğŸ¨</span> è¿›å±±å­¦è‰º
            </button>
        </div>
    </div>

    <!-- 2. åœ°å›¾é¡µ -->
    <div v-if="state === 'map'" class="screen-map">
        <div v-for="(level, idx) in levels" :key="idx" 
             class="level-card" 
             :class="{locked: idx > maxLevel, unlocked: idx <= maxLevel}"
             @click="openStory(idx)">
            <div class="level-num">{{ idx + 1 }}</div>
            <div class="level-name">{{ level.title }}</div>
            <div class="level-stars" v-if="idx < maxLevel">â­â­â­</div>
        </div>
    </div>

    <!-- 3. å‰§æƒ…å¼¹çª— -->
    <div v-if="showStory" class="modal-overlay">
        <div class="story-book">
            <div class="story-left" 
                 :style="currentLevel.type === 'image' ? {backgroundImage: 'url('+currentLevel.src+')'} : {}">
                 <span v-if="currentLevel.type !== 'image'">{{ currentLevel.icon }}</span>
            </div>
            <div class="story-right">
                <h2 style="color: #ff7043; margin: 0; margin-bottom: 10px;">{{ currentLevel.title }}</h2>
                <button class="speak-btn" @click="readStory">ğŸ”Š å†è¯»ä¸€é</button>
                <p class="story-text">{{ currentLevel.story }}</p>
                <button class="btn" @click="startGame">å¼€å§‹æŒ‘æˆ˜ ğŸ’ª</button>
            </div>
        </div>
    </div>

    <!-- 4. æ¸¸æˆé¡µ -->
    <div v-if="state === 'game'" class="screen-game">
        <div class="game-header">
            <button class="btn" style="padding: 8px 20px; font-size: 18px; background: #eee; color: #555;" @click="state='map'">â†© è¿”å›</button>
            <div style="font-size: 24px; color: #8d6e63;">{{ currentLevel.title }}</div>
            <button class="btn" style="background: linear-gradient(45deg, #43a047, #66bb6a);" @click="finishLevel">âœ¨ ç”»å¥½äº†</button>
        </div>

        <div class="guide-layer">
            <svg v-if="currentLevel.type === 'svg'" class="guide-svg" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet">
                <path :d="currentLevel.path" />
            </svg>
            <img v-if="currentLevel.type === 'image'" :src="currentLevel.src" class="guide-image">
        </div>

        <div id="container"></div>
    </div>

    <!-- 5. ç»“ç®—å°ç«  -->
    <div v-if="showResult" class="stamp-modal" @click="closeResult">
        <div class="stamp" :style="{borderColor: resultColor, color: resultColor}">
            {{ resultGrade }}
        </div>
        <p style="font-size: 24px; color: #555; margin-top: 20px;">ç‚¹å‡»ç»§ç»­...</p>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick } = Vue;

    createApp({
        setup() {
            const state = ref('welcome');
            const showStory = ref(false);
            const showResult = ref(false);
            const maxLevel = ref(0); 
            const activeIdx = ref(0);
            const resultGrade = ref('');
            const resultColor = ref('red');
            let stage, layer, currentLine;
            let isDrawing = false;
            let drawCount = 0; 

            // --- è¯­éŸ³åˆæˆå¼•æ“ ---
            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    // åœæ­¢ä¹‹å‰çš„
                    window.speechSynthesis.cancel();
                    const msg = new SpeechSynthesisUtterance();
                    msg.text = text;
                    msg.lang = 'zh-CN'; // å¼ºåˆ¶ä¸­æ–‡
                    msg.rate = 0.9; // è¯­é€Ÿç¨æ…¢ï¼Œé€‚åˆå­©å­
                    window.speechSynthesis.speak(msg);
                }
            };

            // --- å…³å¡é…ç½® (åŒ…å«å®Œæ•´å‰§æœ¬) ---
            const levels = [
                // L1
                { type: 'svg', title: "è¡¥é“é”…", icon: "ğŸ³", path: "M400 150 A 150 150 0 1 1 399 150 Z",
                  story: "ç†Šæ•™å¤´å¤§å¼ä¸€å£°ï¼šâ€˜é‚£ä¸ªå«å¤å¤©çš„ï¼ä½ çœ‹å°çŒªå¦–æŠŠé”…éƒ½åˆ·æ¼äº†ï¼ä»Šæ™šå¤§ç‹å–ä¸åˆ°æ±¤å°±æƒ¨äº†ï¼å¿«ç”»ä¸€ä¸ªåœ†åœ†çš„é“ç‰‡è¡¥ä¸Šï¼â€™" },
                // L2
                { type: 'svg', title: "æ“€é¢æ–", icon: "ğŸ¥–", path: "M100 300 L700 300",
                  story: "çŒªå¦ˆå¦ˆæ¸©æŸ”åœ°è¯´ï¼šâ€˜æ˜¯å¤å¤©å¤§ç‹å—ï¼Ÿæˆ‘æƒ³ç»™å°çŒªå¦–åšè‚‰åŒ…å­ï¼Œå¯æ˜¯æ²¡æœ‰æ“€é¢æ–ã€‚ä½ èƒ½å¸®æˆ‘ç”»ä¸€æ ¹ç›´ç›´çš„æ£å­å—ï¼Ÿâ€™" },
                // L3
                { type: 'svg', title: "ä¸‹å±±è·¯", icon: "â›°ï¸", path: "M100 100 L300 100 L100 300 L300 300 L100 500 L300 500",
                  story: "å°çŒªå¦–å–˜ç€æ°”è¯´ï¼šâ€˜å“å“Ÿï¼æµªæµªå±±å¤ªé™¡äº†ï¼Œæˆ‘åªèƒ½æ»šä¸‹å»å•¦ï¼å¤å¤©å¤§ç‹ï¼Œå¿«å¸®æˆ‘ç”»ä¸€æ¡å¼¯å¼¯æ›²æ›²çš„è·¯ï¼Œè®©æˆ‘æ»‘ä¸‹å»ï¼â€™" },
                // L4
                { type: 'svg', title: "å¹æ³¡æ³¡", icon: "ğŸ«§", path: "M250 300 A 50 50 0 1 1 249 300 Z M550 300 A 100 100 0 1 1 549 300 Z",
                  story: "è›¤èŸ†ç²¾æ‡’æ´‹æ´‹åœ°è¯´ï¼šâ€˜å‘±ï¼æˆ‘æ‰ä¸å»ç æŸ´å‘¢ã€‚å¤å¤©ï¼Œæˆ‘ä»¬æ¥æ¯”èµ›å¹æ³¡æ³¡å§ï¼æˆ‘å¹ä¸ªå¤§çš„ï¼Œä½ ç”»ä¸ªå°çš„ï¼â€™" },
                
                // L5
                { type: 'svg', title: "æ•°æœå­", icon: "1ï¸âƒ£", path: "M150 200 L150 400 M350 200 Q450 150 450 250 Q450 350 300 400 L450 400 M620 200 H 700 L 650 300 Q 720 300 720 400 Q 720 500 620 500",
                  story: "å°çŒªå¦–æŒ æŒ å¤´ï¼šâ€˜ä¸€ã€äºŒã€ä¸‰...å“å‘€æ•°ä¹±äº†ï¼å¤å¤©å¤§ç‹ï¼Œå¸®æˆ‘æŠŠ 1ã€2ã€3 è¿™ä¸‰ä¸ªæ•°å­—å·¥æ•´åœ°å†™ä¸‹æ¥å§ï¼â€™" },
                // L6
                { type: 'svg', title: "ç‚¹åå†Œ", icon: "4ï¸âƒ£", path: "M150 150 L100 300 L250 300 M200 150 L200 400 M450 150 L350 150 L350 250 Q500 250 500 400 Q500 550 350 500 M650 150 Q550 350 550 450 Q550 550 700 550 Q800 550 800 450 Q800 350 650 350",
                  story: "ç†Šæ•™å¤´å¤§å–Šï¼šâ€˜é›†åˆï¼æ€ä¹ˆå°‘äº†å‡ ä¸ªï¼Ÿå¤å¤©ï¼å¿«å¸®æˆ‘æŠŠ 4ã€5ã€6 è®°åœ¨è€ƒå‹¤å†Œä¸Šï¼å­—è¦å†™å¤§ä¸€ç‚¹ï¼â€™" },
                
                // L7
                { type: 'svg', title: "å¤§åœ£ä»£", icon: "ğŸ¦", path: "M350 400 L400 550 L450 400 M370 400 L400 500 M430 400 L400 500 M380 400 L360 450 M420 400 L440 450 M340 400 Q400 350 460 400 M340 400 Q320 300 400 300 Q480 300 460 400 M360 300 Q350 220 400 220 Q450 220 440 300 M400 220 L400 200 M400 200 A 15 15 0 1 1 399 200",
                  story: "å°çŒªå¦–æµç€å£æ°´ï¼šâ€˜æµªæµªå±±å¤ªçƒ­äº†ã€‚å¬è¯´äººç±»æœ‰ç§å«å†°æ·‡æ·‹çš„å¥½åƒçš„ï¼Ÿå¤å¤©å¤§ç‹ï¼Œæˆ‘è¦ä¸‰å±‚å¥¶æ²¹ï¼Œè¿˜è¦åŠ ä¸ªæ¨±æ¡ƒï¼â€™" },
                // L8
                { type: 'svg', title: "ç¥¥ç‘äº‘", icon: "â˜ï¸", path: "M200 300 Q200 200 300 200 Q300 150 400 150 Q500 150 500 200 Q600 200 600 300 Q600 400 500 400 Q500 450 400 450 Q300 450 300 400 Q200 400 200 300 M300 200 Q350 250 300 300 M400 150 Q450 200 400 250 M600 300 Q700 300 800 200",
                  story: "å°çŒªå¦–æœ›ç€å¤©ç©ºï¼šâ€˜å“‡ï¼Œé‚£æ˜¯å¤§åœ£çš„ç­‹æ–—äº‘å—ï¼Ÿå¤å¤©ï¼Œæˆ‘ä»¬ä¹Ÿç”»ä¸€æœµåƒæ£‰èŠ±ç³–ä¸€æ ·çš„äº‘ï¼Œå¸¦æˆ‘ä»¬é£å‡ºæµªæµªå±±å§ï¼â€™" },

                // --- ä¸´æ‘¹å…³å¡ (éœ€å›¾ç‰‡) ---
                { type: 'image', title: "è›¤èŸ†å¤§å“¥", src: "level9.jpg", 
                  story: "å°çŒªå¦–ä»‹ç»è¯´ï¼šâ€˜è¿™æ˜¯æˆ‘çš„å¥½æœ‹å‹è›¤èŸ†å¤§å“¥ã€‚è™½ç„¶ä»–åªæœ‰ä¸€åªçœ¼ç›çœ‹ç€æˆ‘ä»¬ï¼Œå˜´å·´ä¹Ÿå¤§å¤§çš„ï¼Œä½†ä»–å¾ˆè®²ä¹‰æ°”ï¼å¿«ç”»ä¸‹æ¥ï¼â€™" },
                { type: 'image', title: "é»„å…ˆç”Ÿ", src: "level10.jpg", 
                  story: "å°çŒªå¦–æ‚„æ‚„è¯´ï¼šâ€˜å˜˜â€”â€”è¿™æ˜¯é»„é¼ ç‹¼å…ˆç”Ÿï¼Œå±±é‡Œæœ€æœ‰å­¦é—®çš„ã€‚ä½ çœ‹ä»–æˆ´ç€å¤´å·¾ï¼Œè¿˜æœ‰é•¿é•¿çš„èƒ¡å­ï¼Œå¤šç¥æ°”å‘€ï¼â€™" },
                { type: 'image', title: "å°çŒªå¦–", src: "level11.jpg", 
                  story: "å°çŒªå¦–å¼€å¿ƒå¤§ç¬‘ï¼šâ€˜å˜¿å˜¿ï¼Œç»ˆäºè½®åˆ°ç”»æˆ‘å•¦ï¼æˆ‘æ˜¯æµªæµªå±±çš„å°é’»é£ã€‚å¤å¤©å¤§ç‹ï¼Œè®°å¾—æŠŠæˆ‘çš„æ‹›é£è€³ç”»å¤§ä¸€ç‚¹å“¦ï¼â€™" },
                { type: 'image', title: "é½å¤©å¤§åœ£", src: "level12.jpg", 
                  story: "æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»ï¼â€˜å¤©å“ª... æ˜¯ä»–ï¼çœŸçš„æ˜¯ä»–ï¼é½å¤©å¤§åœ£å­™æ‚Ÿç©ºï¼å¤å¤©ï¼Œå¿«æŠŠå¤§åœ£çš„æ ·å­è®°ä¸‹æ¥ï¼ç”»å‡ºä»–çš„é‡‘ç®å’Œé•¿é•¿çš„ç¿æ¯›ï¼â€™" }
            ];

            const currentLevel = computed(() => levels[activeIdx.value]);

            const enterMap = () => { 
                state.value = 'map'; 
                // ç¬¬ä¸€æ¬¡äº¤äº’åï¼Œè¯­éŸ³å¼•æ“é€šå¸¸å°±å‡†å¤‡å¥½äº†
                speakText("å¤å¤©å¤§ç‹ï¼Œè¯·é€‰æ‹©ä»»åŠ¡ï¼");
            };

            const openStory = (idx) => {
                if(idx > maxLevel.value) return; 
                activeIdx.value = idx;
                showStory.value = true;
                // æ‰“å¼€å¼¹çª—ï¼Œè‡ªåŠ¨æœ—è¯»å‰§æƒ…
                speakText(levels[idx].story);
            };

            const readStory = () => {
                speakText(levels[activeIdx.value].story);
            }

            const startGame = () => {
                window.speechSynthesis.cancel(); // åœæ­¢æœ—è¯»
                showStory.value = false;
                state.value = 'game';
                drawCount = 0; 
                nextTick(initCanvas);
            };

            const finishLevel = () => {
                let grade = '';
                let color = '';
                
                if (drawCount < 30) {
                    alert("å¤å¤©è¿˜æ²¡æ€ä¹ˆç”»å‘¢ï¼Œå†å¤šç”»ä¸¤ç¬”ï¼Ÿ");
                    return;
                } else if (drawCount < 100) {
                    grade = "Well Done"; color = "#2196f3";
                } else if (drawCount < 200) {
                    grade = "Excellent"; color = "#9c27b0";
                } else {
                    grade = "Perfect!"; color = "#d32f2f";
                }

                resultGrade.value = grade;
                resultColor.value = color;
                showResult.value = true;
                
                if (['Well Done', 'Excellent', 'Perfect!'].includes(grade)) {
                    fireConfetti();
                    speakText("å¤ªæ£’äº†ï¼é€šå…³å•¦ï¼"); // é€šå…³è¯­éŸ³
                    if (activeIdx.value === maxLevel.value && maxLevel.value < levels.length - 1) {
                        maxLevel.value++;
                    }
                }
            };

            const fireConfetti = () => {
                var duration = 2 * 1000;
                var animationEnd = Date.now() + duration;
                var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };
                var random = (min, max) => Math.random() * (max - min) + min;
                var interval = setInterval(function() {
                    var timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    var particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            };

            const closeResult = () => {
                showResult.value = false;
                state.value = 'map';
            };

            const initCanvas = () => {
                if(stage) stage.destroy();
                stage = new Konva.Stage({
                    container: 'container',
                    width: window.innerWidth,
                    height: window.innerHeight,
                });
                layer = new Konva.Layer();
                stage.add(layer);

                stage.on('mousedown touchstart', () => {
                    isDrawing = true;
                    const pos = stage.getPointerPosition();
                    currentLine = new Konva.Line({
                        stroke: '#5d4037', strokeWidth: 12, 
                        globalCompositeOperation: 'source-over',
                        points: [pos.x, pos.y],
                        lineCap: 'round', lineJoin: 'round', tension: 0.5
                    });
                    layer.add(currentLine);
                });

                stage.on('mousemove touchmove', (e) => {
                    if (!isDrawing) return;
                    e.evt.preventDefault();
                    const pos = stage.getPointerPosition();
                    const newPoints = currentLine.points().concat([pos.x, pos.y]);
                    currentLine.points(newPoints);
                    drawCount++;
                });

                stage.on('mouseup touchend', () => { isDrawing = false; });
            };

            return {
                state, levels, maxLevel, currentLevel,
                showStory, showResult, resultGrade, resultColor,
                enterMap, openStory, startGame, finishLevel, closeResult, readStory
            };
        }
    }).mount('#app');
</script>
</body>
</html>